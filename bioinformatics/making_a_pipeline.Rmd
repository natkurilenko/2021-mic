---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.11.3
  kernelspec:
    display_name: Bash
    language: bash
    name: bash
---

# Making a Pipeline
We are taking baby steps to using Bash in an even more powerful way. First let's just simplify our last notebook by putting the Trimmomatic and STAR commands in the same cell. Before we defined `$SRA_ACCESSION` in both cells and needed to change it in both places. Now we only have it once, which makes for simpler code, which in turn leads to less error prone code

> Note: we really only needed to define `$SRA_ACCESSION` once in the last version, but we had a pattern going.

Load variables from bioinf_config.sh, make a new directory for output, and check that it looks OK.

```{bash}
source bioinf_config.sh
mkdir -p $PIPE_TRIM_DIR $PIPE_STAROUT_DIR
```

## Combining the Steps

```{bash}
SRA_ACCESSION="SRR12804466"
echo "---------------- TRIMMING: $SRA_ACCESSION ----------------"
TrimmomaticPE \
    -threads $TOTAL_THREADS \
    -phred33 \
    ${RAW_FASTQ_DIR}/${SRA_ACCESSION}_1.fastq.gz \
    ${RAW_FASTQ_DIR}/${SRA_ACCESSION}_2.fastq.gz \
    ${PIPE_TRIM_DIR}/${SRA_ACCESSION}_1_trimmed.fastq.gz \
    ${PIPE_TRIM_DIR}/${SRA_ACCESSION}_1_unpaired.fastq.gz \
    ${PIPE_TRIM_DIR}/${SRA_ACCESSION}_2_trimmed.fastq.gz \
    ${PIPE_TRIM_DIR}/${SRA_ACCESSION}_2_unpaired.fastq.gz \
    ILLUMINACLIP:TruSeq2-PE.fa:2:30:10:2:keepBothReads LEADING:3 TRAILING:3 MINLEN:36

echo "---------------- MAPPING: $SRA_ACCESSION ----------------"
STAR \
    --runMode alignReads \
    --twopassMode None \
    --genomeDir $GENOME_DIR \
    --readFilesIn ${PIPE_TRIM_DIR}/${SRA_ACCESSION}_1_trimmed.fastq.gz ${PIPE_TRIM_DIR}/${SRA_ACCESSION}_2_trimmed.fastq.gz \
    --readFilesCommand gunzip -c \
    --outFileNamePrefix ${PIPE_STAROUT_DIR}/${SRA_ACCESSION}_ \
    --quantMode GeneCounts \
    --outSAMtype None \
    --runThreadN $TOTAL_THREADS
```

### And let's check the result

```{bash}
ls ${PIPE_STAROUT_DIR}
```
