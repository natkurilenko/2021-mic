---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.11.2
  kernelspec:
    display_name: R
    language: R
    name: ir
---





# Downstream analysis workshop

## Preparatory steps

### Load packages
```{r}
library(tidyverse)
library(DESeq2)
library(foreach)
```

### Set input files and directories


```{r}
### Location of the meta data file
metadir <- "/data/sra_data/"

### Set meta file
srametafile <- file.path(metadir, "accession_table.csv")
tools::md5sum(srametafile)

### location of STAR count files
cntdir <- "/data/starout/"


### Output directory for R image files from workshop
outdir <- "./workproc/"

if (!dir.exists(outdir)) {
  dir.create(outdir)
}
```


### Function for visualizing effect sizes based on normalized counts for 2 by 2 experiment

```{r}
myinteractplot2by2 <- function(mydds, geneid, mergevar) {
    
    SummarizedExperiment::assay(mydds) %>%
        tibble::as_tibble(rownames="gene") %>%
            dplyr::filter(gene == geneid) %>%
                tidyr::gather(Run, value, -gene) %>%
                    dplyr::select(-gene) -> 
                        expdat
    
    SummarizedExperiment::colData(mydds) %>%
        as.data.frame %>%
            tibble::as_tibble() %>%
                dplyr::full_join(expdat, by = "Run") -> 
                    genedat
    
    genedat %>%
        ggplot2::ggplot(aes(x = cline, y = value/sizeFactor, color = trt)) +
            ggplot2::geom_jitter(width = 0.1) + 
                ggplot2::xlab("Cell line") + ggplot2::ylab(paste(geneid, "(normalized count)")) +
                ggplot2::scale_colour_manual(name = "", values = c("red3", "blue3")) +
                ggplot2::theme_bw()
}
```

## Import meta and count data
### Import meta data file
```{r}
# Import meta data
readr::read_csv(srametafile) ->
    mtdata

mtdata
```

### Import count files

```{r}

### Get count file names 
cntfiles <- list.files(path = cntdir, pattern = "*_ReadsPerGene.out.tab")

### Set column types for count files (four columns)
coltypes <- list(col_character(), col_integer(), col_integer(), col_integer())

## Define merge function
mergefun <- function(df1,df2){
    dplyr::full_join(df1, df2, by = "gene")
}

### Iteratively merge count files

countdata <- foreach(fname = cntfiles, .combine = mergefun) %do% {
    cntfile <- file.path(cntdir, fname)
    readr::read_tsv(cntfile, col_names = FALSE, col_types = coltypes) %>%
    dplyr::select(X1, X2) %>%
    rlang::set_names(c("gene", fname))
}
```

## Create DESeq2 data object


### Function to clean up 
```{r}
cleancolname <- function(x){
    stringr::str_remove(x, "_ReadsPerGene.out.tab$")
}

### Test it
cleancolname('SRR12804463_ReadsPerGene.out.tab')
```

### Create STAR count data matrix

```{r}
### Labels for first four rows of STAR count files
starlabs <- c("N_ambiguous", "N_multimapping", "N_noFeature", "N_unmapped")

countdata %>% 
    dplyr::filter(!gene %in% starlabs) %>%
    data.frame() %>% 
    tibble::column_to_rownames("gene") %>%
    dplyr::rename_with(cleancolname) %>%
    as.matrix -> 
    starcountData

starcountData[1:3,]
```
### Create STAR column data


```{r}
tibble::tibble(Run = colnames(starcountData)) %>%
    dplyr::full_join(mtdata, by = "Run") %>%
    dplyr::mutate(
        trt = factor(gsub("-", "",treatment), levels = c("isotype", "antiPD1")), 
        cline = factor(cell_line, levels = c("Parental", "UV2"))
    ) -> 
    starcolData
```

```{r}
starcolData
```

### 


### Check that the columns of the count matrix agree wite the Run column in metadata

```{r}
identical(starcolData[["Run"]], colnames(starcountData))
```

### Construct DESeq2 data object 


```{r}
PRJNA668393ddsData <- DESeq2::DESeqDataSetFromMatrix(
                                  countData = starcountData,
                                  colData = starcolData,
                                  design = ~1)
```




## Gene level analysis: Additive Model


### Create a new copy of the DESEq2 data object 

```{r}
ddsobj <- PRJNA668393ddsData
```

### Specify design (additive model)

```{r}
design(ddsobj) <- formula(~ cline + trt)
```

### Differential Expression analysis

```{r}
ddsADD <- DESeq2::DESeq(ddsobj)
```

### Tabulate results (sorted by adjusted P-value)

```{r}
DESeq2::results(ddsADD, tidy = TRUE, contrast = c("trt", "antiPD1", "isotype")) %>%
    dplyr::arrange(padj) %>%
    head(10)
```

### Summary of results (using FDR of 0.2)

```{r}
DESeq2::summary(results(ddsADD, contrast = c("trt", "antiPD1", "isotype")), alpha = 0.2)
```
### Visualize treatrment differential effect size based on normalized counts for ENSMUSG00000110537.2 and ENSMUSG00000022564.8

#### Simple plots

```{r}
DESeq2::plotCounts(ddsobj, "ENSMUSG00000110537.2", intgroup = "trt", normalized = TRUE)

```

```{r}
DESeq2::plotCounts(ddsobj, "ENSMUSG00000022564.8", intgroup = "trt", normalized = TRUE)
```

#### Custom plots
```{r}
myinteractplot2by2(ddsADD, "ENSMUSG00000110537.2")
```

```{r}
myinteractplot2by2(ddsADD, "ENSMUSG00000022564.8")
```

### Volcano plot

```{r}
### Volcano plot for treatment effect
DESeq2::results(ddsADD, tidy = TRUE) %>%
    dplyr::filter(!is.na(pvalue)) %>%
        ggplot2::ggplot(aes(x = log2FoldChange, y = -log10(pvalue))) + 
            ggplot2::geom_point() + 
                ggplot2::theme_bw()
```


## Gene level analysis: Multiplicative Model


### Create a new copy of the DESEq2 data object 

```{r}
ddsobj <- PRJNA668393ddsData
```

### Specify design (additive model)

```{r}
design(ddsobj) <- formula(~ cline + trt + cline:trt)
```

### Differential Expression analysis

```{r}
ddsMULT <- DESeq2::DESeq(ddsobj)
```

### Tabulate results (sorted by adjusted P-value)

```{r}
DESeq2::results(ddsMULT, tidy = TRUE) %>%
    dplyr::arrange(padj) %>%
    head(10)
```

### Summary of results (using FDR of 0.2)

```{r}
DESeq2::summary(results(ddsMULT, contrast = c("trt", "antiPD1", "isotype")), alpha = 0.2)
```
### Visualize interaction effect size based on normalized counts for ENSMUSG00000022351.15 and ENSMUSG00000025964.16


#### Custom plots
```{r}
myinteractplot2by2(ddsMULT, "ENSMUSG00000022351.15")
```

```{r}
myinteractplot2by2(ddsMULT, "ENSMUSG00000025964.16")
```

### Volcano plot 

```{r}
DESeq2::results(ddsMULT, tidy = TRUE) %>%
    dplyr::filter(!is.na(pvalue)) %>%
        ggplot2::ggplot(aes(x = log2FoldChange, y = -log10(pvalue))) + 
            ggplot2::geom_point() + 
                ggplot2::theme_bw()
```

## Session Information

```{r}
sessionInfo()
```
